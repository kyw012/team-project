<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Motion Fitness System (Charts + Cloud)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    
    <!-- Dependencies -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>

    <!-- Global Error Handler -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const errorDiv = document.getElementById('error-display');
            if (errorDiv) {
                errorDiv.style.display = 'block';
                errorDiv.innerHTML += `<p><strong>Error:</strong> ${msg}<br><small>${url}:${line}</small></p>`;
            }
            console.error("Global Error:", msg, error);
            return false;
        };
    </script>

    <!-- Firebase SDKs (10.13.1) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updatePassword } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, updateDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        
        window.Firebase = { 
            initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updatePassword,
            getFirestore, collection, doc, setDoc, getDoc, addDoc, onSnapshot, updateDoc, serverTimestamp, query, where, getDocs
        };
        
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .camera-mirror { transform: scaleX(-1); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .prose ul { list-style-type: disc; padding-left: 1.2em; }
        .prose ol { list-style-type: decimal; padding-left: 1.2em; }
        .prose p { margin-bottom: 0.5em; }
        .prose strong { color: #1d4ed8; }
        #error-display { display: none; position: fixed; top: 0; left: 0; width: 100%; background: #fee2e2; color: #991b1b; padding: 10px; z-index: 9999; border-bottom: 1px solid #ef4444; font-size: 12px; font-family: monospace; }
    </style>
</head>
<body>
    <div id="error-display"></div>
    <div id="root"></div>

    <script type="text/babel">
        // =================================================================================
        //  ä½¿ç”¨è€…è¨­å®šå€å¡Š (è«‹å‹™å¿…å¡«å¯«)
        // =================================================================================

        // 1. Firebase è¨­å®š (è«‹å¡«å…¥æ‚¨çš„è¨­å®š)
        const firebaseConfig = {
            apiKey: "AIzaSyBIw4iN7hCMgdTn7ouB6nnGGkAum3p3Iv0",
            authDomain: "fitness-recognition-system.firebaseapp.com",
            projectId: "fitness-recognition-system",
            storageBucket: "fitness-recognition-system.firebasestorage.app",
            messagingSenderId: "144226041118",
            appId: "1:144226041118:web:80ea44e2a61258ebebdd0f",
        };

        // 2. Gemini API Key
        const geminiApiKey = "AIzaSyDshbg0D7uQhOLJBsmqfzKT6UJgyso0SQk";

        // =================================================================================
        //  æ‡‰ç”¨ç¨‹å¼é‚è¼¯
        // =================================================================================

        const { useState, useEffect, useRef, useMemo } = React;
        const Recharts = window.Recharts || {};
        const { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        const EXERCISES = {
            1: { name: 'Squat', label: 'æ·±è¹²', calorieFactor: 0.5 },
            2: { name: 'Plank', label: 'å¹³æ¿æ’', calorieFactor: 4.0 }
        };

        // Inline Icons
        const Icons = {
            Activity: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            User: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            BarChart2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>,
            MessageSquare: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
            LogOut: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Play: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            Camera: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            Save: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            ChevronRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="9 18 15 12 9 6"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>,
            Loader2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            BrainCircuit: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/><path d="M3.477 10.896a4 4 0 0 1 .585-.396"/><path d="M19.938 10.5a4 4 0 0 1 .585.396"/><path d="M6 18a4 4 0 0 1-1.97-1.364"/><path d="M19.97 16.636A4 4 0 0 1 18 18"/></svg>,
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 1-2-2v.09a2 2 0 0 1-2 2H3.78a2 2 0 0 1-2-2V3.78a2 2 0 0 1 2-2h.09a2 2 0 0 1 2 2v.44a2 2 0 0 1 2 2h.44a2 2 0 0 1 2-2v-.09a2 2 0 0 1 2-2H20.22a2 2 0 0 1 2 2v16.44a2 2 0 0 1-2 2h-16.44a2 2 0 0 1-2-2V3.78a2 2 0 0 1 2-2h.44a2 2 0 0 1 2 2v.44a2 2 0 0 1 2-2H7.78a2 2 0 0 1 2 2v16.44a2 2 0 0 1-2 2h16.44a2 2 0 0 1-2-2V7.78a2 2 0 0 1-2-2h-.44z"/><circle cx="12" cy="12" r="3"/></svg>,
            Edit2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Check: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="20 6 9 17 4 12"/></svg>,
            Eye: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            EyeOff: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
        };
        const { Activity, User, BarChart2, MessageSquare, LogOut, Play, Camera, Save, ChevronRight, Sparkles, Loader2, BrainCircuit, Settings, Edit2, Check, Eye, EyeOff } = Icons;

        const useFirebase = () => {
            const [firebase, setFirebase] = useState(window.Firebase || null);
            useEffect(() => {
                if (window.Firebase) {
                    setFirebase(window.Firebase);
                } else {
                    const handler = () => setFirebase(window.Firebase);
                    window.addEventListener('firebase-ready', handler);
                    const timer = setTimeout(() => {
                        if (!window.Firebase) console.warn("Firebase loading timeout.");
                    }, 5000);
                    return () => {
                        window.removeEventListener('firebase-ready', handler);
                        clearTimeout(timer);
                    };
                }
            }, []);
            return firebase;
        };

        const callGeminiAPI = async (prompt) => {
            if (!geminiApiKey || geminiApiKey.includes("è«‹åœ¨æ­¤å¡«å…¥")) {
                return "éŒ¯èª¤ï¼šè«‹å…ˆåœ¨ç¨‹å¼ç¢¼é–‹é ­å¡«å…¥æ‚¨çš„ Gemini API Keyã€‚";
            }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            const delays = [1000, 2000, 4000];
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                         const errData = await response.json();
                         return `API Error: ${errData.error?.message || response.statusText}`;
                    }
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "AI æš«ç„¡å›æ‡‰";
                } catch (error) {
                    if (i === delays.length) return "é€£ç·šé€¾æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚";
                    await new Promise(resolve => setTimeout(resolve, delays[i]));
                }
            }
        };

        const calculateAngle = (a, b, c) => {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) angle = 360 - angle;
            return angle;
        };

        const analyzeSquat = (landmarks, state) => {
            const hip = landmarks[23], knee = landmarks[25], ankle = landmarks[27];
            if (hip.visibility < 0.5 || knee.visibility < 0.5 || ankle.visibility < 0.5) 
                return { angle: 0, newState: state, feedback: "å…¨èº«å…¥é¡" };

            const angle = calculateAngle(hip, knee, ankle);
            let newState = { ...state };
            let feedback = "ç«™ç«‹";

            if (angle > 160) { newState.stage = "UP"; feedback = "æº–å‚™"; }
            if (angle < 100 && newState.stage === "UP") { newState.stage = "DOWN"; feedback = "ä¿æŒ"; }
            if (angle > 150 && newState.stage === "DOWN") {
                newState.stage = "UP"; newState.count += 1;
                const quality = Math.min(100, Math.max(60, 100 - Math.abs(90 - newState.minAngleInRep))); 
                newState.lastScore = quality; 
                newState.minAngleInRep = 180;
                feedback = "å®Œæˆ +1";
            }
            if (newState.stage === "DOWN") {
                if (angle < newState.minAngleInRep) newState.minAngleInRep = angle;
                if (angle < 75) feedback = "å¤ªä½"; else if (angle > 110) feedback = "è¹²ä½é»";
            }
            return { angle: Math.round(angle), newState, feedback };
        };

        const Navbar = ({ activeTab, setActiveTab, onLogout }) => {
            const navItems = [
                { id: 'dashboard', label: 'å„€è¡¨æ¿', icon: Activity },
                { id: 'workout', label: 'è¨“ç·´', icon: Play },
                { id: 'report', label: 'å ±å‘Š', icon: BarChart2 },
                { id: 'coach', label: 'AIæ•™ç·´', icon: BrainCircuit },
                { id: 'profile', label: 'å¸³è™Ÿ', icon: User },
            ];
            return (
                <nav className="bg-white shadow-md fixed bottom-0 w-full md:top-0 md:bottom-auto z-50 md:h-16 flex justify-between items-center px-4">
                    <div className="hidden md:flex items-center gap-2">
                        <div className="bg-blue-600 p-2 rounded-lg"><Activity className="text-white w-6 h-6" /></div>
                        <span className="text-xl font-bold text-gray-800">MotionAI</span>
                    </div>
                    <div className="flex w-full md:w-auto justify-between md:justify-center md:gap-6">
                        {navItems.map(item => (
                            <button key={item.id} onClick={() => setActiveTab(item.id)}
                                className={`flex flex-col md:flex-row items-center gap-1 p-2 md:px-3 rounded-lg transition-colors ${
                                    activeTab === item.id ? 'text-blue-600 md:bg-blue-50' : 'text-gray-400 hover:text-gray-700'
                                }`}>
                                <item.icon className="w-6 h-6 md:w-5 md:h-5" />
                                <span className="text-[10px] md:text-sm font-medium">{item.label}</span>
                            </button>
                        ))}
                    </div>
                    <div className="hidden md:block">
                        <button onClick={onLogout} className="text-red-500 hover:text-red-700 text-sm font-medium flex items-center gap-1">
                            <LogOut className="w-4 h-4" /> ç™»å‡º
                        </button>
                    </div>
                </nav>
            );
        };

        const Login = ({ appId }) => {
            const [mode, setMode] = useState('login'); 
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [error, setError] = useState('');
            const [currentUser, setCurrentUser] = useState(null);

            useEffect(() => {
                if (window.Firebase) {
                    const auth = window.Firebase.getAuth();
                    if (auth.currentUser) setCurrentUser(auth.currentUser);
                }
            }, []);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSubmitting(true);
                setError('');

                if (!window.Firebase) {
                    setError("SDK å°šæœªè¼‰å…¥");
                    setIsSubmitting(false);
                    return;
                }

                let auth;
                try {
                    auth = window.Firebase.getAuth();
                } catch (err) {
                    setError("Firebase åˆå§‹åŒ–å¤±æ•—ï¼šè«‹æª¢æŸ¥ Config è¨­å®š");
                    setIsSubmitting(false);
                    return;
                }

                const db = window.Firebase.getFirestore();

                try {
                    if (currentUser && !name) {
                        await window.Firebase.setDoc(window.Firebase.doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'info'), { 
                            name: "User", email: currentUser.email, joinedAt: new Date().toISOString() 
                        });
                        return;
                    }

                    if (mode === 'register') {
                        if(!name) throw new Error("è«‹å¡«å¯«æš±ç¨±");
                        const userCredential = await window.Firebase.createUserWithEmailAndPassword(auth, email, password);
                        const user = userCredential.user;
                        await window.Firebase.setDoc(window.Firebase.doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info'), { 
                            name, email, joinedAt: new Date().toISOString() 
                        });
                    } else {
                        await window.Firebase.signInWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    console.error("Auth Error:", err);
                    let msg = err.message;
                    if (msg.includes("email-already-in-use")) msg = "æ­¤ Email å·²è¢«è¨»å†Š";
                    if (msg.includes("wrong-password")) msg = "å¯†ç¢¼éŒ¯èª¤";
                    if (msg.includes("user-not-found")) msg = "æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿ";
                    if (msg.includes("invalid-credential")) msg = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦";
                    if (msg.includes("weak-password")) msg = "å¯†ç¢¼å¼·åº¦ä¸è¶³ (éœ€6ä½ä»¥ä¸Š)";
                    if (msg.includes("invalid-email")) msg = "Email æ ¼å¼éŒ¯èª¤";
                    if (msg.includes("too-many-requests")) msg = "å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦";
                    setError(mode === 'register' ? "è¨»å†Šå¤±æ•—: " + msg : "ç™»å…¥å¤±æ•—: " + msg);
                    setIsSubmitting(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-600 to-purple-700 p-4">
                    <div className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
                        <div className="text-center mb-6">
                            <div className="bg-blue-100 p-3 rounded-full inline-block mb-4"><Activity className="w-8 h-8 text-blue-600" /></div>
                            <h1 className="text-2xl font-bold text-gray-800">MotionAI Cloud</h1>
                            <p className="text-gray-500 text-sm mt-2">å»ºç«‹æ‚¨çš„é›²ç«¯å¥èº«æª”æ¡ˆ</p>
                        </div>
                        <div className="flex bg-gray-100 p-1 rounded-lg mb-6">
                            <button onClick={() => { setMode('login'); setError(''); }} className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${mode === 'login' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>ç™»å…¥</button>
                            <button onClick={() => { setMode('register'); setError(''); }} className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${mode === 'register' ? 'bg-white shadow text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>è¨»å†Š</button>
                        </div>
                        {error && <div className="mb-4 p-3 bg-red-100 text-red-700 text-sm rounded-lg border border-red-200 flex items-center gap-2"><span className="text-xl">âš ï¸</span><span>{error}</span></div>}
                        <form onSubmit={handleSubmit} className="space-y-4">
                            {mode === 'register' && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">æš±ç¨± (Name)</label>
                                    <input type="text" required className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="å¦‚ä½•ç¨±å‘¼æ‚¨?" value={name} onChange={(e) => setName(e.target.value)} />
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">å¸³è™Ÿ (Email)</label>
                                <input type="email" required className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="name@example.com" value={email} onChange={(e) => setEmail(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">å¯†ç¢¼ (Password)</label>
                                <div className="relative">
                                    <input type={showPassword ? "text" : "password"} required className="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none pr-10" placeholder="è‡³å°‘ 6 ä½æ•¸" value={password} onChange={(e) => setPassword(e.target.value)} />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3 text-gray-400 hover:text-gray-600 focus:outline-none">{showPassword ? <EyeOff className="w-5 h-5" /> : <Eye className="w-5 h-5" />}</button>
                                </div>
                            </div>
                            <button type="submit" disabled={isSubmitting} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition-colors flex justify-center items-center gap-2 mt-2">{isSubmitting && <Loader2 className="animate-spin w-5 h-5" />}{isSubmitting ? 'è™•ç†ä¸­...' : (mode === 'register' ? 'ç«‹å³è¨»å†Š' : 'ç™»å…¥ç³»çµ±')}</button>
                        </form>
                    </div>
                </div>
            );
        };

        const Profile = ({ userProfile, fbUser, db, appId, onLogout }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [formData, setFormData] = useState({ name: userProfile?.name || '', email: userProfile?.email || '', newPassword: '' });
            const [showNewPassword, setShowNewPassword] = useState(false);
            const [msg, setMsg] = useState('');
            const [errorMsg, setErrorMsg] = useState('');

            const handleSave = async () => {
                if (!fbUser || !db) return;
                setMsg('');
                setErrorMsg('');
                try {
                    await window.Firebase.updateDoc(
                        window.Firebase.doc(db, 'artifacts', appId, 'users', fbUser.uid, 'profile', 'info'),
                        { name: formData.name, email: formData.email }
                    );
                    if (formData.newPassword) {
                        if (formData.newPassword.length < 6) throw new Error("æ–°å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 ä½æ•¸");
                        await window.Firebase.updatePassword(fbUser, formData.newPassword);
                        setMsg('è³‡æ–™èˆ‡å¯†ç¢¼å·²æ›´æ–°');
                    } else {
                        setMsg('è³‡æ–™å·²æ›´æ–°');
                    }
                    setIsEditing(false);
                    setFormData(prev => ({ ...prev, newPassword: '' }));
                    setTimeout(() => setMsg(''), 3000);
                } catch (e) {
                    console.error(e);
                    let errText = e.message;
                    if (errText.includes("requires-recent-login")) errText = "ç‚ºç¢ºä¿å®‰å…¨ï¼Œä¿®æ”¹å¯†ç¢¼å‰è«‹å…ˆç™»å‡ºä¸¦é‡æ–°ç™»å…¥ã€‚";
                    setErrorMsg('æ›´æ–°å¤±æ•—: ' + errText);
                }
            };

            return (
                <div className="p-6 max-w-2xl mx-auto animate-fade-in space-y-6">
                    <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><User className="w-6 h-6 text-blue-600" /> å¸³è™Ÿç®¡ç†</h1>
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div className="bg-blue-600 p-6 text-white flex flex-col items-center">
                            <div className="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mb-3 text-3xl font-bold">{userProfile?.name?.[0]?.toUpperCase() || 'U'}</div>
                            <h2 className="text-xl font-bold">{userProfile?.name}</h2>
                            <p className="text-blue-100 text-sm">{userProfile?.email || 'æœªè¨­å®š Email'}</p>
                        </div>
                        <div className="p-6 space-y-4">
                            <div className="flex justify-between items-center mb-2">
                                <h3 className="font-bold text-gray-700">åŸºæœ¬è³‡æ–™</h3>
                                {!isEditing && <button onClick={() => setIsEditing(true)} className="text-blue-600 hover:text-blue-700 text-sm flex items-center gap-1"><Edit2 className="w-4 h-4" /> ç·¨è¼¯</button>}
                            </div>
                            <div className="space-y-3">
                                <div><label className="text-xs text-gray-500">é¡¯ç¤ºåç¨±</label>{isEditing ? <input type="text" value={formData.name} onChange={e=>setFormData({...formData, name: e.target.value})} className="w-full border rounded p-2 mt-1 focus:ring-2 focus:ring-blue-500 outline-none" /> : <p className="text-gray-800 font-medium">{userProfile?.name}</p>}</div>
                                <div><label className="text-xs text-gray-500">è¯çµ¡ Email</label>{isEditing ? <input type="email" value={formData.email} onChange={e=>setFormData({...formData, email: e.target.value})} className="w-full border rounded p-2 mt-1 focus:ring-2 focus:ring-blue-500 outline-none" /> : <p className="text-gray-800 font-medium">{userProfile?.email || '-'}</p>}</div>
                                {isEditing && (
                                    <div className="pt-2 border-t mt-2">
                                        <label className="text-xs text-gray-500 font-bold block mb-1">ä¿®æ”¹å¯†ç¢¼ (ç•™ç©ºå‰‡ä¸ä¿®æ”¹)</label>
                                        <div className="relative">
                                            <input type={showNewPassword ? "text" : "password"} value={formData.newPassword} onChange={e=>setFormData({...formData, newPassword: e.target.value})} className="w-full border rounded p-2 mt-1 focus:ring-2 focus:ring-blue-500 outline-none pr-10" placeholder="è¼¸å…¥æ–°å¯†ç¢¼" />
                                            <button type="button" onClick={() => setShowNewPassword(!showNewPassword)} className="absolute right-3 top-3 text-gray-400 hover:text-gray-600 focus:outline-none">{showNewPassword ? <EyeOff className="w-4 h-4" /> : <Eye className="w-4 h-4" />}</button>
                                        </div>
                                        <p className="text-[10px] text-gray-400 mt-1">æ³¨æ„ï¼šè‹¥è¦ä¿®æ”¹å¯†ç¢¼ï¼Œæ‚¨å¿…é ˆæ˜¯æœ€è¿‘å‰›ç™»å…¥çš„ç‹€æ…‹ã€‚è‹¥å¤±æ•—è«‹é‡æ–°ç™»å…¥å†è©¦ã€‚</p>
                                    </div>
                                )}
                            </div>
                            {isEditing && (
                                <div className="flex gap-3 pt-4">
                                    <button onClick={handleSave} className="flex-1 bg-blue-600 text-white py-2 rounded-lg flex justify-center items-center gap-2"><Check className="w-4 h-4" /> å„²å­˜è®Šæ›´</button>
                                    <button onClick={() => setIsEditing(false)} className="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg">å–æ¶ˆ</button>
                                </div>
                            )}
                            {msg && <div className="text-center text-sm text-green-600 bg-green-50 p-2 rounded">{msg}</div>}
                            {errorMsg && <div className="text-center text-sm text-red-600 bg-red-50 p-2 rounded">{errorMsg}</div>}
                            <hr className="my-4" />
                            <button onClick={onLogout} className="w-full bg-red-50 text-red-600 py-3 rounded-lg font-bold flex justify-center items-center gap-2 hover:bg-red-100 transition-colors"><LogOut className="w-5 h-5" /> ç™»å‡ºç³»çµ±</button>
                        </div>
                    </div>
                </div>
            );
        };

        const Dashboard = ({ userProfile, trainingRecords, setActiveTab }) => {
            const stats = useMemo(() => {
                if (!trainingRecords.length) return { totalReps: 0, avgScore: 0, totalCalories: 0, totalTime: 0, lastDate: 'ç„¡ç´€éŒ„' };
                const total = trainingRecords.reduce((acc, curr) => acc + (curr.Quantity || 0), 0);
                const avg = Math.round(trainingRecords.reduce((acc, curr) => acc + (curr.AiScore || 0), 0) / trainingRecords.length);
                const last = new Date(trainingRecords[trainingRecords.length - 1].Date.seconds * 1000 || Date.now());
                const totalCal = trainingRecords.reduce((acc, curr) => acc + (curr.CaloriesConsumed || 0), 0);
                const totalMin = trainingRecords.reduce((acc, curr) => acc + (curr.DurationMinutes || 0), 0);
                return { totalReps: total, avgScore: avg, totalCalories: Math.round(totalCal), totalTime: totalMin.toFixed(1), lastDate: last.toLocaleDateString() };
            }, [trainingRecords]);

            // --- 1. é«”èƒ½è¶¨å‹¢ (Trend Chart Logic) ---
            const trendData = useMemo(() => {
                const sorted = [...trainingRecords].sort((a, b) => (a.Date?.seconds || 0) - (b.Date?.seconds || 0));
                const grouped = {};
                sorted.forEach(r => {
                    const date = r.Date?.seconds ? new Date(r.Date.seconds * 1000) : new Date();
                    const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                    if (!grouped[dateStr]) grouped[dateStr] = { total: 0, count: 0 };
                    grouped[dateStr].total += r.AiScore;
                    grouped[dateStr].count += 1;
                });
                return Object.keys(grouped).map(date => ({
                    date,
                    score: Math.round(grouped[date].total / grouped[date].count)
                })).slice(-7); 
            }, [trainingRecords]);

            // --- 2. æ¯é€±é‹å‹•é‡ (Weekly Frequency Chart Logic) ---
            const weeklyData = useMemo(() => {
                const days = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
                const data = days.map(d => ({ day: d, count: 0 }));
                
                const now = new Date();
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(now.getDate() - 6);
                oneWeekAgo.setHours(0, 0, 0, 0); 
                
                trainingRecords.forEach(r => {
                    const rDate = r.Date?.seconds ? new Date(r.Date.seconds * 1000) : new Date();
                    if (rDate >= oneWeekAgo) {
                        const dayIndex = rDate.getDay(); 
                        data[dayIndex].count += (r.Quantity || 0);
                    }
                });
                
                const ordered = [];
                for (let i = 1; i <= 6; i++) ordered.push(data[i]); // Mon-Sat
                ordered.push(data[0]); // Sun
                return ordered;
            }, [trainingRecords]);

            return (
                <div className="p-6 max-w-5xl mx-auto space-y-6 animate-fade-in">
                    <header>
                        <h1 className="text-2xl font-bold text-gray-800">æ—©å®‰ï¼Œ{userProfile?.name} ğŸ‘‹</h1>
                        <p className="text-gray-500">æ‚¨çš„è¨“ç·´æ•¸æ“š (Weekly Summary)</p>
                    </header>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <p className="text-gray-400 text-xs font-medium">ç¸½æ¬¡æ•¸ (Reps)</p>
                            <h3 className="text-2xl font-bold text-blue-600 mt-1">{stats.totalReps}</h3>
                        </div>
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <p className="text-gray-400 text-xs font-medium">æ¶ˆè€—å¡è·¯é‡Œ</p>
                            <h3 className="text-2xl font-bold text-orange-500 mt-1">{Math.round(stats.totalCalories)}</h3>
                        </div>
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <p className="text-gray-400 text-xs font-medium">è¨“ç·´æ™‚é–“ (åˆ†)</p>
                            <h3 className="text-2xl font-bold text-purple-600 mt-1">{stats.totalTime}</h3>
                        </div>
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100">
                            <p className="text-gray-400 text-xs font-medium">å¹³å‡åˆ†æ•¸</p>
                            <h3 className="text-2xl font-bold text-green-600 mt-1">{stats.avgScore}</h3>
                        </div>
                    </div>

                    {/* --- New Charts Section --- */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {/* 1. Trend Chart */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-gray-700 mb-4">é«”èƒ½è¶¨å‹¢ (åˆ†æ•¸è®ŠåŒ–)</h3>
                            <div className="h-64">
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={trendData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <XAxis dataKey="date" tick={{fontSize: 12}} />
                                        <YAxis domain={[0, 100]} hide />
                                        <Tooltip />
                                        <Line type="monotone" dataKey="score" stroke="#10b981" strokeWidth={3} dot={{r: 4, fill: '#10b981'}} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                        
                        {/* 2. Frequency Chart */}
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                            <h3 className="font-bold text-gray-700 mb-4">æ¯é€±é‹å‹•é‡ (æ¬¡æ•¸)</h3>
                            <div className="h-64">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={weeklyData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                        <XAxis dataKey="day" tick={{fontSize: 12}} />
                                        <YAxis hide />
                                        <Tooltip cursor={{fill: 'transparent'}} />
                                        <Bar dataKey="count" fill="#3b82f6" radius={[4, 4, 0, 0]} barSize={30} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm p-6 flex flex-col md:flex-row items-center gap-6 border border-gray-100">
                        <div className="flex-1">
                            <h2 className="text-xl font-bold text-gray-800 mb-2">é–‹å§‹æ–°çš„è¨“ç·´</h2>
                            <p className="text-gray-500 mb-4 text-sm">AI å‹•ä½œè¾¨è­˜å¼•æ“å·²æº–å‚™å°±ç·’ã€‚</p>
                            <button onClick={() => setActiveTab('workout')} className="bg-gray-900 hover:bg-gray-800 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all">
                                <Play className="w-5 h-5" /> é€²å…¥è¨“ç·´æ¨¡å¼
                            </button>
                        </div>
                        <div className="bg-gray-50 p-4 rounded-full"><Activity className="w-12 h-12 text-blue-300" /></div>
                    </div>
                </div>
            );
        };

        const Workout = ({ onFinish, db, fbUser, appId }) => {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const [count, setCount] = useState(0);
            const [feedback, setFeedback] = useState("è«‹å•Ÿå‹•ç›¸æ©Ÿ");
            const [angle, setAngle] = useState(0);
            const workoutState = useRef({ stage: "UP", count: 0, minAngleInRep: 180, lastScore: 0 });
            const requestRef = useRef(null);
            const poseRef = useRef(null);
            const startTimeRef = useRef(null);
            const [cameraStatus, setCameraStatus] = useState('idle');
            const [errorMsg, setErrorMsg] = useState("");

            useEffect(() => {
                const pose = new Pose({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
                pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
                pose.onResults((results) => {
                    if (canvasRef.current && results.poseLandmarks) {
                         const ctx = canvasRef.current.getContext('2d');
                         const { width, height } = canvasRef.current;
                         ctx.save();
                         ctx.clearRect(0, 0, width, height);
                         if(window.drawConnectors) window.drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, { color: '#00FF00', lineWidth: 4 });
                         if(window.drawLandmarks) window.drawLandmarks(ctx, results.poseLandmarks, { color: '#FF0000', lineWidth: 2, radius: 4 });
                         ctx.restore();
                    }
                    if(!results.poseLandmarks) return;
                    const analysis = analyzeSquat(results.poseLandmarks, workoutState.current);
                    workoutState.current = analysis.newState;
                    setAngle(analysis.angle);
                    setFeedback(analysis.feedback);
                    setCount(workoutState.current.count);
                });
                poseRef.current = pose;
                return () => {
                    if(requestRef.current) cancelAnimationFrame(requestRef.current);
                    if(poseRef.current) poseRef.current.close();
                    if(videoRef.current?.srcObject) videoRef.current.srcObject.getTracks().forEach(t => t.stop());
                };
            }, []);

            const startCamera = async () => {
                setCameraStatus('loading');
                setErrorMsg("");
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) throw new Error("ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿ API");
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'user' } });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                        videoRef.current.onloadedmetadata = () => {
                            videoRef.current.play();
                            setCameraStatus('active');
                            setFeedback("è«‹ç«™åœ¨é¡é ­å‰");
                            startTimeRef.current = Date.now();
                            loop();
                        };
                    }
                } catch (err) {
                    console.error(err);
                    setCameraStatus('error');
                    setErrorMsg(err.name === 'NotAllowedError' ? "è«‹å…è¨±ç€è¦½å™¨å­˜å–ç›¸æ©Ÿæ¬Šé™" : `ç›¸æ©ŸéŒ¯èª¤: ${err.message}`);
                }
            };

            const loop = async () => {
                if (videoRef.current && poseRef.current && !videoRef.current.paused && !videoRef.current.ended && videoRef.current.readyState >= 2) {
                    await poseRef.current.send({ image: videoRef.current });
                }
                if (videoRef.current) requestRef.current = requestAnimationFrame(loop);
            };

            const handleSave = async () => {
                if(count === 0) { onFinish(); return; }
                setFeedback("å„²å­˜ä¸­...");
                try {
                    const exerciseId = 1; 
                    const exerciseData = EXERCISES[exerciseId];
                    const durationMs = Date.now() - (startTimeRef.current || Date.now());
                    const durationMinutes = parseFloat((durationMs / 60000).toFixed(2));
                    const score = Math.min(100, Math.round(80 + (count * 2))); 
                    const calories = count * exerciseData.calorieFactor;

                    const recordRef = await window.Firebase.addDoc(
                        window.Firebase.collection(db, 'artifacts', appId, 'users', fbUser.uid, 'training_records'),
                        {
                            ExerciseID: exerciseId,
                            Date: window.Firebase.serverTimestamp(),
                            Quantity: count,
                            AiScore: score,
                            DurationMinutes: durationMinutes,
                            CaloriesConsumed: calories
                        }
                    );

                    const issue = score < 80 ? "Depth insufficient" : "None";
                    const suggestion = score < 80 ? "å»ºè­°ä¸‹æ¬¡è¹²æ›´ä½ä¸€é»ï¼Œç¢ºä¿å¤§è…¿å¹³è¡Œåœ°é¢ã€‚" : "å‹•ä½œæ¨™æº–ï¼Œç¹¼çºŒä¿æŒï¼";
                    
                    await window.Firebase.addDoc(
                        window.Firebase.collection(db, 'artifacts', appId, 'users', fbUser.uid, 'ai_feedback'),
                        {
                            RecordID: recordRef.id,
                            AiSuggestion: suggestion,
                            IssueDetected: issue
                        }
                    );

                    onFinish();
                } catch(e) {
                    alert("å„²å­˜å¤±æ•—: " + e.message);
                    onFinish();
                }
            };

            return (
                <div className="flex flex-col h-full bg-gray-900 text-white">
                    <div className="flex-1 relative flex items-center justify-center overflow-hidden">
                        {cameraStatus === 'idle' && (
                            <div className="absolute z-20 flex flex-col items-center">
                                <div className="bg-gray-800 p-6 rounded-xl shadow-lg text-center">
                                    <Camera className="w-16 h-16 text-blue-500 mx-auto mb-4"/>
                                    <h3 className="text-xl font-bold mb-2">æº–å‚™é–‹å§‹è¨“ç·´</h3>
                                    <button onClick={startCamera} className="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-xl font-bold flex items-center gap-2 mx-auto"><Play className="w-5 h-5" /> å•Ÿå‹•ç›¸æ©Ÿ</button>
                                </div>
                            </div>
                        )}
                        {cameraStatus === 'loading' && <div className="absolute z-20 flex flex-col items-center"><Loader2 className="animate-spin w-12 h-12 text-blue-500" /><p className="mt-4 text-gray-300">å•Ÿå‹•ç›¸æ©Ÿä¸­...</p></div>}
                        {cameraStatus === 'error' && <div className="absolute z-20 p-4 bg-red-900 rounded text-white">{errorMsg}<button onClick={startCamera} className="ml-2 underline">é‡è©¦</button></div>}
                        
                        <div className="relative w-[640px] h-[480px] bg-black rounded-lg overflow-hidden border border-gray-700">
                            <video ref={videoRef} className="w-full h-full object-cover camera-mirror opacity-80" playsInline muted></video>
                            <canvas ref={canvasRef} width={640} height={480} className="absolute top-0 left-0 w-full h-full camera-mirror pointer-events-none" />
                            {cameraStatus === 'active' && (
                                <div className="absolute bottom-8 w-full flex justify-center"><span className={`px-6 py-2 rounded-full text-lg font-bold shadow-lg ${feedback.includes('å®Œæˆ')?'bg-green-600':'bg-blue-600'}`}>{feedback}</span></div>
                            )}
                        </div>
                    </div>
                    <div className="bg-gray-800 p-4 flex justify-between items-center pb-20 md:pb-4">
                        <div><p className="text-gray-400 text-xs">COUNT</p><p className="text-4xl font-bold">{count}</p></div>
                        <button onClick={handleSave} className="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-xl font-bold flex items-center gap-2"><Save className="w-5 h-5" /> çµæŸä¸¦å„²å­˜</button>
                    </div>
                </div>
            );
        };

        const Report = ({ trainingRecords }) => {
            const [aiMsg, setAiMsg] = useState(null);
            const [loading, setLoading] = useState(false);

            const askAI = async () => {
                if(!trainingRecords.length) return;
                setLoading(true);
                const dataStr = JSON.stringify(trainingRecords.slice(-5).map(h => ({ 
                    date: new Date(h.Date.seconds*1000).toLocaleDateString(), 
                    qty: h.Quantity, 
                    score: h.AiScore,
                    cal: h.CaloriesConsumed 
                })));
                const res = await callGeminiAPI(`ä½ æ˜¯å¥èº«æ•™ç·´ã€‚åˆ†ææ•¸æ“šä¸¦çµ¦å»ºè­°(ç¹ä¸­):\n${dataStr}`);
                setAiMsg(res);
                setLoading(false);
            };

            return (
                <div className="p-6 max-w-6xl mx-auto pb-24 md:pb-6 animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><BarChart2 className="w-6 h-6 text-blue-600"/> æ­·å²è¨“ç·´è³‡æ–™</h1>
                        {trainingRecords.length > 0 && <button onClick={askAI} disabled={loading} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 disabled:opacity-50">{loading ? <Loader2 className="animate-spin w-4 h-4"/> : <Sparkles className="w-4 h-4"/>} AI ç¸½çµ</button>}
                    </div>
                    {aiMsg && <div className="bg-indigo-50 p-6 rounded-xl mb-6 prose prose-sm max-w-none" dangerouslySetInnerHTML={{__html: marked.parse(aiMsg)}} />}
                    
                    {trainingRecords.length === 0 ? <div className="text-center py-20 text-gray-500 bg-white rounded-xl">å°šç„¡ç´€éŒ„</div> : (
                        <div className="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100 overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-gray-50 text-gray-500 font-medium border-b">
                                    <tr>
                                        <th className="p-4 whitespace-nowrap">æ—¥æœŸ</th>
                                        <th className="p-4 whitespace-nowrap">é …ç›®</th>
                                        <th className="p-4 whitespace-nowrap">æ¬¡æ•¸/æ™‚é–“</th>
                                        <th className="p-4 whitespace-nowrap">åˆ†æ•¸</th>
                                        <th className="p-4 whitespace-nowrap">æŒçºŒ(åˆ†)</th>
                                        <th className="p-4 whitespace-nowrap">å¡è·¯é‡Œ</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {trainingRecords.slice().reverse().map((h, i) => {
                                        const dateStr = h.Date?.seconds ? new Date(h.Date.seconds * 1000).toLocaleString() : 'Processing...';
                                        return (
                                            <tr key={i} className="hover:bg-gray-50">
                                                <td className="p-4">{dateStr}</td>
                                                <td className="p-4 font-bold text-blue-600">{EXERCISES[h.ExerciseID]?.label || 'æœªçŸ¥'}</td>
                                                <td className="p-4">{h.Quantity}</td>
                                                <td className="p-4"><span className={`px-2 py-1 rounded-full text-xs ${h.AiScore>=80?'bg-green-100 text-green-800':'bg-yellow-100 text-yellow-800'}`}>{h.AiScore}</span></td>
                                                <td className="p-4">{h.DurationMinutes?.toFixed(1)}</td>
                                                <td className="p-4 text-gray-500">{h.CaloriesConsumed?.toFixed(1)} kcal</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        };

        const AICoach = ({ trainingRecords }) => {
            const [msgs, setMsgs] = useState([{ role: 'ai', content: 'æˆ‘æ˜¯ Gemini AI æ•™ç·´ã€‚æœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«ä½ çš„å—ï¼Ÿ' }]);
            const [input, setInput] = useState('');
            const [busy, setBusy] = useState(false);
            const endRef = useRef(null);
            useEffect(() => endRef.current?.scrollIntoView({behavior:'smooth'}), [msgs]);
            const send = async (e) => {
                e.preventDefault();
                if(!input.trim()) return;
                const userText = input;
                setMsgs(p => [...p, { role: 'user', content: userText }]);
                setInput('');
                setBusy(true);
                const context = trainingRecords.length ? `ä½¿ç”¨è€…æœ€è¿‘ç´€éŒ„: ${JSON.stringify(trainingRecords.slice(-3))}` : "ä½¿ç”¨è€…å°šç„¡è¨“ç·´ç´€éŒ„";
                const prompt = `ä½ æ˜¯æœ‰è¶£çš„å¥èº«æ•™ç·´ã€‚${context}ã€‚ä½¿ç”¨è€…èªª: "${userText}"ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ç°¡çŸ­å›ç­”ã€‚`;
                const res = await callGeminiAPI(prompt);
                setMsgs(p => [...p, { role: 'ai', content: res }]);
                setBusy(false);
            };
            return (
                <div className="flex flex-col h-[calc(100vh-64px)] md:h-[calc(100vh-80px)] max-w-3xl mx-auto p-4">
                    <div className="flex-1 bg-white rounded-2xl border border-gray-200 overflow-hidden flex flex-col shadow-sm">
                        <div className="bg-indigo-600 p-4 text-white font-bold flex gap-2"><BrainCircuit/> Gemini Coach</div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                            {msgs.map((m, i) => (<div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}><div className={`max-w-[85%] p-3 rounded-2xl text-sm ${m.role==='user'?'bg-indigo-600 text-white rounded-br-none':'bg-white border rounded-bl-none text-gray-800'}`}>{m.role === 'ai' ? <div dangerouslySetInnerHTML={{__html: marked.parse(m.content)}}/> : m.content}</div></div>))}
                            {busy && <div className="flex"><div className="bg-white border p-2 rounded-2xl rounded-bl-none text-xs text-gray-400">æ€è€ƒä¸­...</div></div>}
                            <div ref={endRef}/>
                        </div>
                        <form onSubmit={send} className="p-3 bg-white border-t flex gap-2"><input value={input} onChange={e=>setInput(e.target.value)} placeholder="å•å•æ•™ç·´..." className="flex-1 bg-gray-100 rounded-xl px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500"/><button disabled={busy} className="bg-indigo-600 text-white p-2 rounded-xl disabled:opacity-50"><ChevronRight/></button></form>
                    </div>
                </div>
            );
        };

        const App = () => {
            const Firebase = useFirebase();
            const [fbUser, setFbUser] = useState(null);
            const [userProfile, setUserProfile] = useState(null);
            const [trainingRecords, setTrainingRecords] = useState([]);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [initLoading, setInitLoading] = useState(true);
            const [configError, setConfigError] = useState(null);

            const appId = 'my-local-fitness-app-v2';

            useEffect(() => {
                if (!Firebase) return;
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("è«‹åœ¨æ­¤å¡«å…¥")) {
                    setConfigError("è«‹åœ¨ç¨‹å¼ç¢¼ä¸­å¡«å…¥æ­£ç¢ºçš„ Firebase Config é‡‘é‘°");
                    setInitLoading(false);
                    return;
                }
                try {
                    Firebase.initializeApp(firebaseConfig);
                } catch (e) {
                    if (!e.message.includes('already exists')) {
                        setConfigError("Firebase åˆå§‹åŒ–å¤±æ•—: " + e.message);
                        setInitLoading(false);
                        return;
                    }
                }
                const auth = Firebase.getAuth();
                const unsubAuth = Firebase.onAuthStateChanged(auth, (u) => {
                    setFbUser(u);
                    if (!u) {
                        setUserProfile(null);
                        setTrainingRecords([]);
                        setInitLoading(false);
                    }
                });
                return () => unsubAuth();
            }, [Firebase]);

            useEffect(() => {
                if (!Firebase || !fbUser) return;
                const { getFirestore, doc, onSnapshot, collection } = Firebase;
                const db = getFirestore();

                const unsubProfile = onSnapshot(doc(db, 'artifacts', appId, 'users', fbUser.uid, 'profile', 'info'), (snap) => {
                    setUserProfile(snap.exists() ? snap.data() : null);
                    setInitLoading(false);
                }, err => console.error(err));

                const unsubRecords = onSnapshot(collection(db, 'artifacts', appId, 'users', fbUser.uid, 'training_records'), (snap) => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    list.sort((a, b) => (a.Date?.seconds || 0) - (b.Date?.seconds || 0));
                    setTrainingRecords(list);
                }, err => console.error(err));

                return () => { unsubProfile(); unsubRecords(); };
            }, [Firebase, fbUser]);

            const handleLogout = async () => {
                if (!window.Firebase) return;
                const auth = window.Firebase.getAuth();
                await window.Firebase.signOut(auth);
                setActiveTab('dashboard');
            };

            if (initLoading) return <div className="h-screen flex flex-col items-center justify-center text-blue-600 gap-2"><Loader2 className="animate-spin w-8 h-8"/><span className="text-sm font-medium">ç³»çµ±å•Ÿå‹•ä¸­...</span></div>;
            if (configError) return <div className="h-screen flex items-center justify-center text-red-600 font-bold p-8 text-center">{configError}</div>;
            if (!fbUser || !userProfile) return <Login appId={appId} />;

            const db = Firebase ? Firebase.getFirestore() : null;

            return (
                <div className="min-h-screen font-sans text-gray-900 pb-16 md:pb-0 pt-0 md:pt-16">
                    <Navbar activeTab={activeTab} setActiveTab={setActiveTab} onLogout={handleLogout} />
                    <main className="h-full">
                        {activeTab === 'dashboard' && <Dashboard userProfile={userProfile} trainingRecords={trainingRecords} setActiveTab={setActiveTab} />}
                        {activeTab === 'workout' && <Workout onFinish={() => setActiveTab('report')} db={db} fbUser={fbUser} appId={appId} />}
                        {activeTab === 'report' && <Report trainingRecords={trainingRecords} />}
                        {activeTab === 'coach' && <AICoach trainingRecords={trainingRecords} />}
                        {activeTab === 'profile' && <Profile userProfile={userProfile} fbUser={fbUser} db={db} appId={appId} onLogout={handleLogout} />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>